workflows:
  ios-native-workflow:
    name: iOS Native
    max_build_duration: 120
    integrations:
      app_store_connect: CodeMagic Api Key
      app_store_connect: CodeMagic Api Key Push
    environment:
      ios_signing:
        distribution_type: app_store
        bundle_identifier: com.youncherreunapp
      vars:
        BUNDLE_ID: "com.youncherreunapp"
        XCODE_PROJECT: "HenTrack.xcodeproj" # Убедитесь, что имя проекта указано правильно
        XCODE_SCHEME: "HenTrack" # Убедитесь, что имя схемы указано правильно
        APP_STORE_APPLE_ID: 6749678981
        TEAM_ID: "3H5P4974N7"  # Ваш Team ID
      xcode: 16.3
    scripts:
      - name: Set up provisioning profiles settings on Xcode project
        script: xcode-project use-profiles

      - name: Increment build number
        script: |
          cd "$CM_BUILD_DIR"
          LATEST_BUILD_NUMBER=$(app-store-connect get-latest-app-store-build-number "$APP_STORE_APPLE_ID")
          agvtool new-version -all $(($LATEST_BUILD_NUMBER + 1))

      - name: Build ipa for distribution (with full xcodebuild logs)
        script: |
          set -euo pipefail
          cd "$CM_BUILD_DIR"

          LOG_DIR="/tmp/xcodebuild_logs"
          mkdir -p "$LOG_DIR"

          ARCHIVE_PATH="$CM_BUILD_DIR/build/ios/xcarchive/${XCODE_SCHEME}_$(date +%s).xcarchive"
          EXPORT_PATH="$CM_BUILD_DIR/build/ios/ipa"
          mkdir -p "$EXPORT_PATH"

          echo "=== START: xcodebuild archive ==="
          # Archive (captures full output into archive.log and prints to console)
          xcodebuild -project "$XCODE_PROJECT" \
            -scheme "$XCODE_SCHEME" \
            -configuration Release \
            -archivePath "$ARCHIVE_PATH" \
            archive \
            COMPILER_INDEX_STORE_ENABLE=NO \
            DEVELOPMENT_TEAM="$TEAM_ID" \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Apple Distribution" 2>&1 | tee "$LOG_DIR/archive.log"

          # Проверка успешности xcodebuild (на exit code в пайпе)
          if [ "${PIPESTATUS[0]}" -ne 0 ]; then
            echo "Archive failed. See $LOG_DIR/archive.log"
            exit 65
          fi
          echo "=== OK: archive complete ==="

          # Создаём exportOptions.plist для экспорта .ipa (app-store)
          cat > "$CM_BUILD_DIR/exportOptions.plist" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>uploadSymbols</key>
            <true/>
            <key>compileBitcode</key>
            <false/>
          </dict>
          </plist>
          EOF

          echo "=== START: xcodebuild -exportArchive ==="
          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportPath "$EXPORT_PATH" \
            -exportOptionsPlist "$CM_BUILD_DIR/exportOptions.plist" 2>&1 | tee "$LOG_DIR/export.log"

          if [ "${PIPESTATUS[0]}" -ne 0 ]; then
            echo "Export failed. See $LOG_DIR/export.log"
            exit 65
          fi
          echo "=== OK: export complete ==="

          echo "IPA location (if any):"
          ls -la "$EXPORT_PATH" || true

    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.app
      - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.dSYM

    publishing:
      email:
        recipients:
          - osmanmedal55@gmail.com
        notify:
          success: true
          failure: false
      app_store_connect:
        auth: integration
        submit_to_testflight: false
        submit_to_app_store: false
